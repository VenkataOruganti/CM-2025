<?php
/**
 * =============================================================================
 * SAREE BLOUSE FRONT PATTERN
 * =============================================================================
 *
 * Generates the front panel pattern for a saree blouse.
 *
 * MODES:
 * - Standalone: Full HTML preview (default) - for development/testing
 * - Composite:  Returns SVG + data only (when COMPOSITE_MODE defined)
 *
 * USAGE:
 *   Standalone: sariBlouseFront.php?customer_id=123&measurement_id=456&mode=dev
 *   Composite:  define('COMPOSITE_MODE', true); include 'sariBlouseFront.php';
 *
 * EXPORTS (when included):
 *   $frontPatternData - Array with nodes, svg_content, dimensions
 *
 * =============================================================================
 */

// =============================================================================
// SECTION 1: CONFIGURATION & DATA LOADING
// =============================================================================

// Only load config if not already loaded by composite
if (!defined('PATTERN_CONFIG_LOADED')) {
    require_once __DIR__ . '/patternConfig.php';
}

// Calculate armhole (with origin offset) - uses measurements from patternConfig
calculateArmhole(1.0, $originX, $originY);

// =============================================================================
// SECTION 2: FRONT PATTERN CALCULATIONS
// =============================================================================

// Pre-calculate values needed for nodes
$shoulderLine_x = $pointA_x - ($shoulder * $scale);

// Front neck depth calculation (diagonal from a10 to a1)
$a1_horizontal = $shoulderLine_x - $originX;
$a1_diagonal = $frontNeckDepth * $scale;
$a1_vertical = sqrt(pow($a1_diagonal, 2) - pow($a1_horizontal, 2));
$a1_y = $originY + $a1_vertical;

// Shoulder Mid x-coordinate (needed for a4 and b1)
$shoulderMid_x = (($pointA_x - ($shoulder * $scale)) + $pointA_x) / 2;
$shoulderMid_y = ($originY + $pointA_y) / 2;

// =============================================================================
// FRONT PATTERN NODES
// =============================================================================
$frontNodes = [];

// Node 0: Origin (top-left corner) - GRAY reference point
$frontNodes['a0'] = [
    'x' => $originX,
    'y' => $originY,
    'label' => 'Origin',
    'color' => 'gray',
    'code' => '$a0 = originX, originY'
];

// Node 1: Front Neck Depth (diagonal distance from a10 to a1)
$frontNodes['a1'] = [
    'x' => $originX,
    'y' => $originY + $a1_vertical,
    'label' => 'Front Neck',
    'code' => '$a1 = originX, diagonal ' . number_format($frontNeckDepth, 2) . '" from a10'
];

// Node 3: Front Length point (bottom left corner - vertical down from a1)
$frontNodes['a3'] = [
    'x' => $originX - (0.25 * $scale),
    'y' => $originY + (($flength - 1.0) * $scale),
    'label' => 'Front Length',
    'code' => '$a3 = originX - 0.25", a0.y + flength(' . number_format($flength, 2) . '")'
];

// Node 4: Waist curve control point (x = b1.x (shoulder midpoint), y = a11.y + flength + 0.5")
$frontNodes['a4'] = [
    'x' => $shoulderMid_x,
    'y' => $originY + (($flength + 0.5) * $scale),
    'label' => 'a4',
    'code' => '$a4 = b1.x, a11.y + flength(' . number_format($flength, 2) . '") + 0.5"'
];

// Node 5: Waist point (qBust * scale, a4.y - 0.5")
$frontNodes['a5'] = [
    'x' => $qBust * $scale,
    'y' => $frontNodes['a4']['y'] - (0.5 * $scale),
    'label' => 'Waist',
    'code' => '$a5 = qBust(' . number_format($qBust, 2) . '") * ' . $scale . ', a4.y - 0.5"'
];

// Node 7: Intersection of armhole level and bust line
$frontNodes['a7'] = [
    'x' => $qBust * $scale,
    'y' => $pointC_y,
    'label' => 'a7',
    'code' => '$a7 = qBust(' . number_format($qBust, 2) . '") * ' . $scale . ', a8.y'
];

// Node 51: 1.5" right of a5, on the same angle as a4-a5 line
$a4_a5_slope = ($frontNodes['a5']['y'] - $frontNodes['a4']['y']) / ($frontNodes['a5']['x'] - $frontNodes['a4']['x']);
$frontNodes['a51'] = [
    'x' => $frontNodes['a5']['x'] + (1.5 * $scale),
    'y' => $frontNodes['a5']['y'] + ($a4_a5_slope * 1.5 * $scale),
    'label' => 'a51',
    'code' => '$a51 = a5.x + 1.5", a5.y + (slope × 1.5")'
];

// Node 71: 1.5" right of a7 (right edge of side box)
$frontNodes['a71'] = [
    'x' => $frontNodes['a7']['x'] + (1.5 * $scale),
    'y' => $frontNodes['a7']['y'],
    'label' => 'a71',
    'code' => '$a71 = a7.x + 1.5", a7.y'
];

// Node 8: Armhole End (Point C)
$frontNodes['a8'] = [
    'x' => $pointC_x,
    'y' => $pointC_y,
    'label' => 'Armhole End',
    'code' => '$a8 = pointC_x, pointC_y'
];

// Node 9: Armhole Corner (45° bend - Point B1)
$frontNodes['a9'] = [
    'x' => $pointB1_x,
    'y' => $pointB1_y,
    'label' => 'Armhole Corner',
    'code' => '$a9 = pointB1_x, pointB1_y'
];

// Node 91: Armhole Curve Midpoint (AB2 - on curve between a9 and a10)
$frontNodes['a91'] = [
    'x' => $pointAB2_x,
    'y' => $pointAB2_y,
    'label' => 'Armhole Mid',
    'code' => '$a91 = pointAB2_x, pointAB2_y'
];

// Node 10: Shoulder (top of armhole - Point A)
$frontNodes['a10'] = [
    'x' => $pointA_x,
    'y' => $pointA_y,
    'label' => 'Shoulder',
    'code' => '$a10 = pointA_x, pointA_y'
];

// Node 11: Shoulder Line (top, end of shoulder near neck)
$frontNodes['a11'] = [
    'x' => $pointA_x - ($shoulder * $scale),
    'y' => $originY,
    'label' => 'Shoulder Line',
    'code' => '$a11 = a10.x - shoulder(' . number_format($shoulder, 2) . '"), a0.y'
];

// Node 111: Midpoint between a11 and a1 (for neck curve) - adjusted +0.5" right, +1" down
$frontNodes['a111'] = [
    'x' => $shoulderLine_x + (0.5 * $scale),
    'y' => (($frontNodes['a1']['y'] + $frontNodes['a11']['y']) / 2) + (1.0 * $scale),
    'label' => 'a111',
    'code' => '$a111 = a11.x + 0.5", midpoint(a1.y, a11.y) + 1"'
];

// Shoulder Mid: Reference point (gray) - midpoint of shoulder line (a11 to a10)
$frontNodes['sMid'] = [
    'x' => $shoulderMid_x,
    'y' => $shoulderMid_y,
    'label' => 'Shoulder Mid',
    'color' => 'gray',
    'code' => '$sMid = midpoint(a11, a10)'
];

// Node b1: x = sMid.x (aligned with shoulder midpoint), y = apex level
$frontNodes['b1'] = [
    'x' => $shoulderMid_x,
    'y' => $originY + ($apex * $scale),
    'label' => 'b1',
    'code' => '$b1 = sMid.x, apex'
];

// Node b3: x = sMid.x (aligned with shoulder midpoint), y = apex + 1"
$frontNodes['b3'] = [
    'x' => $shoulderMid_x,
    'y' => $originY + (($apex + 1) * $scale),
    'label' => 'b3',
    'code' => '$b3 = sMid.x, apex + 1"'
];

// Helper function to get node coordinates (scoped to front pattern)
if (!function_exists('frontNode')) {
    function frontNode($name, $coord = null) {
        global $frontNodes;
        if (!isset($frontNodes[$name])) return null;
        if ($coord === 'x') return $frontNodes[$name]['x'];
        if ($coord === 'y') return $frontNodes[$name]['y'];
        return $frontNodes[$name];
    }
}

// =============================================================================
// WAIST CURVE CONTROL POINT
// =============================================================================
$a3_a4_distance = abs(frontNode('a4', 'x') - frontNode('a3', 'x'));
$waistCurveBulgeRatio = 0.30;
$waistCurveBulgeDepth = $a3_a4_distance * $waistCurveBulgeRatio;
$waistCurveControlPointPosition = 0.35;

$q_ctrl_left_x = frontNode('a3', 'x') + (frontNode('a4', 'x') - frontNode('a3', 'x')) * $waistCurveControlPointPosition;
$q_ctrl_left_y = frontNode('a3', 'y') + (frontNode('a4', 'y') - frontNode('a3', 'y')) * $waistCurveControlPointPosition + $waistCurveBulgeDepth;

// =============================================================================
// BOTTOM TUCK NODES (b2, b4)
// =============================================================================
$b2_x = $shoulderMid_x - (($bottomTuckWidth / 2) * $scale);
$a3_x_val = frontNode('a3', 'x');
$a3_y_val = frontNode('a3', 'y');
$a4_x_val = frontNode('a4', 'x');
$a4_y_val = frontNode('a4', 'y');
$ctrl_x = $q_ctrl_left_x;
$ctrl_y = $q_ctrl_left_y;
$t_b2 = ($a4_x_val - $b2_x) / ($a4_x_val - $a3_x_val);
$b2_y = pow(1-$t_b2, 2) * $a4_y_val + 2*(1-$t_b2)*$t_b2 * $ctrl_y + pow($t_b2, 2) * $a3_y_val;
// Node b2: left side of bottom tuck
$frontNodes['b2'] = [
    'x' => $b2_x,
    'y' => $b2_y,
    'label' => 'b2',
    'code' => '$b2 = sMid.x - (bottomTuckWidth/2), on waist curve'
];

$b4_x = $shoulderMid_x + (($bottomTuckWidth / 2) * $scale);
$a5_x_val = frontNode('a5', 'x');
$a5_y_val = frontNode('a5', 'y');
$b4_y = $a4_y_val + ($b4_x - $a4_x_val) * ($a5_y_val - $a4_y_val) / ($a5_x_val - $a4_x_val);

// Node b4: right side of bottom tuck
$frontNodes['b4'] = [
    'x' => $b4_x,
    'y' => $b4_y,
    'label' => 'b4',
    'code' => '$b4 = sMid.x + (bottomTuckWidth/2), on waist line'
];

// sideTuck_Left nodes (near apex level - left side)
// c1: 0.25" above b1(y) (apex level)
$frontNodes['c1'] = [
    'x' => $originX,
    'y' => $frontNodes['b1']['y'] - (0.25 * $scale),
    'label' => 'c1',
    'code' => '$c1 = a0.x, b1.y - 0.25"'
];

// c2: (b1.x - a0.x) - 1" from a0, aligned with b1 at apex level
$frontNodes['c2'] = [
    'x' => frontNode('b1','x') - (1 * $scale),
    'y' => $frontNodes['b1']['y'],
    'label' => 'c2',
    'code' => '$c2 = b1.x - 1", b1.y'
];

// c3: 0.25" below b1(y) (apex level)
$frontNodes['c3'] = [
    'x' => $originX,
    'y' => $frontNodes['b1']['y'] + (0.25 * $scale),
    'label' => 'c3',
    'code' => '$c3 = a0.x, b1.y + 0.25"'
];

// armholeTuck nodes (at a9 - armhole corner, pointing to b1)
// Width of e1-e3 = distance from a8 to a7
$a8_a7_distance = frontNode('a7','x') - frontNode('a8','x');  // horizontal distance a8 to a7
$e_half_width = $a8_a7_distance / 2;  // half the tuck width (from center a9)

// e1: half of a8-a7 distance above a9 (along the armhole curve direction - toward a10)
$frontNodes['e1'] = [
    'x' => $pointB1_x - ($e_half_width * cos(deg2rad(45))),
    'y' => $pointB1_y - ($e_half_width * sin(deg2rad(45))),
    'label' => 'e1',
    'code' => '$e1 = a9 - (a8-a7)/2 toward a10 = ' . number_format($a8_a7_distance / $scale, 2) . '" total width'
];

// e2: 1" from b1 toward a9 (along the b1-a9 line)
$e2_dx = $pointB1_x - frontNode('b1','x');
$e2_dy = $pointB1_y - frontNode('b1','y');
$e2_angle = atan2($e2_dy, $e2_dx);
$e2_dist = 1.0 * $scale;
$frontNodes['e2'] = [
    'x' => frontNode('b1','x') + ($e2_dist * cos($e2_angle)),
    'y' => frontNode('b1','y') + ($e2_dist * sin($e2_angle)),
    'label' => 'e2',
    'code' => '$e2 = 1" from b1 toward a9'
];

// e3: half of a8-a7 distance below a9 (along the armhole curve direction - toward a8)
$frontNodes['e3'] = [
    'x' => $pointB1_x + ($e_half_width * cos(deg2rad(45))),
    'y' => $pointB1_y + ($e_half_width * sin(deg2rad(45))),
    'label' => 'e3',
    'code' => '$e3 = a9 + (a8-a7)/2 toward a8 = ' . number_format($a8_a7_distance / $scale, 2) . '" total width'
];

// =============================================================================
// 4TH TUCK NODES (f1, f2, f3) - base on a7-a5 line, apex at b1(x) + 1"
// =============================================================================
$f_tuck_base_x = frontNode('a7', 'x');  // a7.x = a5.x (on the side seam line)
$f_tuck_apex_x = frontNode('b1', 'x') + (1 * $scale);  // b1.x + 1" (apex points inward)
$f_tuck_center_y = (frontNode('a7', 'y') + frontNode('a5', 'y')) / 2;  // midpoint between a7.y and a5.y

// f1: b1.y - 0.25", on the a7-a5 line (side seam)
$frontNodes['f1'] = [
    'x' => $f_tuck_base_x,
    'y' => frontNode('b1', 'y') - (0.25 * $scale),
    'label' => 'f1',
    'code' => '$f1 = a7.x, b1.y - 0.25"'
];

// f2: tuck apex - at b1.x + 1", y = b1.y
$frontNodes['f2'] = [
    'x' => $f_tuck_apex_x,
    'y' => frontNode('b1', 'y'),
    'label' => 'f2',
    'code' => '$f2 = b1.x + 1", b1.y'
];

// f3: b1.y + 0.25", on the a7-a5 line (side seam)
$frontNodes['f3'] = [
    'x' => $f_tuck_base_x,
    'y' => frontNode('b1', 'y') + (0.25 * $scale),
    'label' => 'f3',
    'code' => '$f3 = a7.x, b1.y + 0.25"'
];

// =============================================================================
// CUTTING LINE NODES (r = red line seam allowance)
// Uniform 0.5" offset from pattern, following the a-nodes
// =============================================================================
$seamOffset = 0.5;  // 0.5" uniform offset

// r1: aligned with a3.x, 0.25" below a3 (bottom-left corner)
$frontNodes['r1'] = [
    'x' => frontNode('a3','x'),
    'y' => frontNode('a3','y') + (0.25 * $scale),
    'label' => 'r1',
    'color' => 'red',
    'code' => '$r1 = a3.x, a3.y + 0.25"'
];

// r2: 0.5" below a4 (waist curve peak)
$frontNodes['r2'] = [
    'x' => frontNode('a4','x'),
    'y' => frontNode('a4','y') + (0.25 * $scale),
    'label' => 'r2',
    'color' => 'red',
    'code' => '$r2 = a4 + 0.25" down'
];

// r3: a51.x + 0.25" (1.75" right of a5.x), 0.25" down from a51 (waist right)
$frontNodes['r3'] = [
    'x' => frontNode('a51','x'),
    'y' => frontNode('a51','y') + (0.25 * $scale),
    'label' => 'r3',
    'color' => 'red',
    'code' => '$r3 = a51.x, a51.y + 0.25"'
];

// r5: a71.x + 0.25" (1.75" right of a7.x), 0.25" up from a71 (intersection)
$frontNodes['r5'] = [
    'x' => frontNode('a71','x'),
    'y' => frontNode('a71','y') - (0.25 * $scale),
    'label' => 'r5',
    'color' => 'red',
    'code' => '$r5 = a71.x, a71.y - 0.25"'
];

// r6: aligned with z6.x (pointC_x), 0.25" up from a8.y (armhole end)
$frontNodes['r6'] = [
    'x' => $pointC_x,
    'y' => frontNode('a8','y') - (0.25 * $scale),
    'label' => 'r6',
    'color' => 'red',
    'code' => '$r6 = z6.x, a8.y - 0.25"'
];

// r7: 0.25" right and 0.25" up from a10
$frontNodes['r7'] = [
    'x' => frontNode('a10','x') + (0.25 * $scale),
    'y' => frontNode('a10','y') - (0.25 * $scale),
    'label' => 'r7',
    'color' => 'red',
    'code' => '$r7 = a10.x + 0.25", a10.y - 0.25"'
];

// r71: between r7 and r6 at a111(y) level on outer cutting line (armhole side)
$frontNodes['r71'] = [
    'x' => frontNode('r7','x'),
    'y' => frontNode('a111','y'),
    'label' => 'r71',
    'color' => 'red',
    'code' => '$r71 = r7.x, a111.y'
];

// r8: 0.5" left and 0.5" up from a11 (shoulder line end)
$frontNodes['r8'] = [
    'x' => frontNode('a11','x') - (0.25 * $scale),
    'y' => frontNode('a11','y') - (0.25 * $scale),
    'label' => 'r8',
    'color' => 'red',
    'code' => '$r8 = a11.x - 0.25", a11.y - 0.25"'
];

// r9: aligned with a1.x (includes 0.25" ease), 0.25" above a1.y (front neck level)
$frontNodes['r9'] = [
    'x' => frontNode('a1','x'),
    'y' => frontNode('a1','y') - (0.25 * $scale),
    'label' => 'r9',
    'color' => 'red',
    'code' => '$r9 = a1.x (with ease), a1.y - 0.25"'
];

// r91: midpoint on outer red cutting line between r9 and r8 (at a111 level)
$frontNodes['r91'] = [
    'x' => frontNode('a111','x') - (0.25 * $scale),
    'y' => frontNode('a111','y'),
    'label' => 'r91',
    'color' => 'red',
    'code' => '$r91 = a111.x - 0.25", a111.y'
];

// =============================================================================
// PATTI PATTERN CALCULATIONS (positioned below front pattern)
// =============================================================================
$pattiWidth = $qBust;  // bust / 4
$pattiHeight = $blength - $flength;

// Patti origin - positioned below the front pattern with 1" gap
$pattiGap = 1;  // 1" gap between front and patti patterns
$pattiOriginX = frontNode('a3', 'x');  // Follow a3.x position
$pattiOriginY = $originY + (($flength + $pattiGap) * $scale);

// =============================================================================
// PATTI NODES (p prefix to avoid conflict with front nodes)
// =============================================================================
$pattiNodes = [];

// Helper function for patti nodes
if (!function_exists('pattiNode')) {
    function pattiNode($name, $coord = null) {
        global $pattiNodes;
        if (!isset($pattiNodes[$name])) return null;
        if ($coord === 'x') return $pattiNodes[$name]['x'];
        if ($coord === 'y') return $pattiNodes[$name]['y'];
        return $pattiNodes[$name];
    }
}

// Get a3, a4, a5 offsets from front nodes for patti shape
$p_a4_x_offset = frontNode('a4', 'x') - frontNode('a3', 'x');
$p_a4_y_offset = frontNode('a4', 'y') - frontNode('a3', 'y');
$p_a5_x_offset = frontNode('a5', 'x') - frontNode('a3', 'x');
$p_a5_y_offset = frontNode('a5', 'y') - frontNode('a3', 'y');

// p1 = top-left (corresponds to a3 position)
$pattiNodes['p1'] = [
    'x' => $pattiOriginX,
    'y' => $pattiOriginY,
    'label' => 'p1',
    'code' => '$p1 = patti origin (a3 position)'
];

// p2 = top curve point (corresponds to a4 position)
$pattiNodes['p2'] = [
    'x' => $pattiOriginX + $p_a4_x_offset,
    'y' => $pattiOriginY + $p_a4_y_offset,
    'label' => 'p2',
    'code' => '$p2 = a4 position (offset from a3)'
];

// p3 = top-right (adjusted: base position minus bust-waist difference + 1", y - 0.5")
// qBust - qWaist gives the actual quarter bust-waist difference (ease cancels out)
$pattiNodes['p3'] = [
    'x' => ($pattiOriginX + $p_a5_x_offset - (($qBust - $qWaist) * $scale) + (1 * $scale)),
    'y' => $pattiOriginY + $p_a5_y_offset - (0.5 * $scale),
    'label' => 'p3',
    'code' => '$p3 = (pattiOriginX + (a5.x - a3.x) - (qBust - qWaist) + 1") * scale, y - 0.5"'
];

// p4 = bottom-left
$pattiNodes['p4'] = [
    'x' => $originX,
    'y' => $pattiNodes['p2']['y'] + ($pattiHeight * $scale),
    'label' => 'p4',
    'code' => '$p4 = originX, p2.y + pattiHeight'
];

// p5 = bottom-right (aligned with p3.x)
$pattiNodes['p5'] = [
    'x' => $pattiNodes['p3']['x'],
    'y' => $pattiNodes['p2']['y'] + ($pattiHeight * $scale),
    'label' => 'p5',
    'code' => '$p5 = p3.x, p2.y + pattiHeight'
];

// Vertical guide line position for patti
$patti_a8_a3_distance = frontNode('a8', 'x') - frontNode('a3', 'x');
$pattiVerticalLineX = pattiNode('p1', 'x') + $patti_a8_a3_distance;

// Patti waist curve control points (matching a3→a4 curvature)
// Use same bulge ratio and control point position as front pattern
$patti_p1_p2_distance = abs(pattiNode('p2', 'x') - pattiNode('p1', 'x'));
$pattiWaistCurveBulgeDepth = $patti_p1_p2_distance * $waistCurveBulgeRatio;
$p_ctrl_x = pattiNode('p1', 'x') + (pattiNode('p2', 'x') - pattiNode('p1', 'x')) * $waistCurveControlPointPosition;
$p_ctrl_y = pattiNode('p1', 'y') + (pattiNode('p2', 'y') - pattiNode('p1', 'y')) * $waistCurveControlPointPosition + $pattiWaistCurveBulgeDepth;

// =============================================================================
// SVG DIMENSIONS (includes both front and patti patterns)
// =============================================================================
$frontSvgWidthInches = ($qBust + 2.5);
// Height = top margin (1") + flength + pattiGap + a4_y_offset (waist curve dip) + pattiHeight + bottom margin (1.5")
// The a4_y_offset accounts for the waist curve extending below flength
$a4_y_offset_inches = $p_a4_y_offset / $scale;  // Convert back to inches
$frontSvgHeightInches = (1.0 + $flength + $pattiGap + $a4_y_offset_inches + $pattiHeight + 1.5);
$frontSvgWidth = $frontSvgWidthInches * $scale;
$frontSvgHeight = $frontSvgHeightInches * $scale;

// Calculate bounding box
$frontBounds = [
    'minX' => 0,
    'minY' => 0,
    'width' => $frontSvgWidth,
    'height' => $frontSvgHeight
];

// =============================================================================
// HELPER FUNCTIONS FOR RENDERING
// =============================================================================

// Snip Icon helper
if (!function_exists('snipIcon')) {
    function snipIcon($refNumber, $label, $nodeGetter, $nodeName, $angle, $size = 0.225, $offsetX = 0, $offsetY = 0) {
        global $scale, $isPrintMode, $isDevMode;
        $tipX = call_user_func($nodeGetter, $nodeName, 'x') + ($offsetX * $scale);
        $tipY = call_user_func($nodeGetter, $nodeName, 'y') + ($offsetY * $scale);
        if ($tipX === null || $tipY === null) return '';

        $sizeScaled = $size * $scale;
        switch($angle) {
            case 0: case 360:
                $x1 = $tipX; $y1 = $tipY;
                $x2 = $tipX - $sizeScaled; $y2 = $tipY - ($sizeScaled / 2);
                $x3 = $tipX - $sizeScaled; $y3 = $tipY + ($sizeScaled / 2);
                $labelX = $tipX - $sizeScaled - (0.15 * $scale); $labelY = $tipY;
                break;
            case 90:
                $x1 = $tipX; $y1 = $tipY;
                $x2 = $tipX - ($sizeScaled / 2); $y2 = $tipY - $sizeScaled;
                $x3 = $tipX + ($sizeScaled / 2); $y3 = $tipY - $sizeScaled;
                $labelX = $tipX; $labelY = $tipY - $sizeScaled - (0.15 * $scale);
                break;
            case 180:
                $x1 = $tipX; $y1 = $tipY;
                $x2 = $tipX + $sizeScaled; $y2 = $tipY - ($sizeScaled / 2);
                $x3 = $tipX + $sizeScaled; $y3 = $tipY + ($sizeScaled / 2);
                $labelX = $tipX + $sizeScaled + (0.15 * $scale); $labelY = $tipY;
                break;
            case 270:
                $x1 = $tipX; $y1 = $tipY;
                $x2 = $tipX - ($sizeScaled / 2); $y2 = $tipY + $sizeScaled;
                $x3 = $tipX + ($sizeScaled / 2); $y3 = $tipY + $sizeScaled;
                $labelX = $tipX; $labelY = $tipY + $sizeScaled + (0.15 * $scale);
                break;
            default: return '';
        }

        $svg = '<g class="snip-marker">';
        $svg .= sprintf('<line class="snip-triangle" x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#333333" stroke-width="0.5"/>', $x1, $y1, $x2, $y2);
        $svg .= sprintf('<line class="snip-triangle" x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#333333" stroke-width="0.5"/>', $x1, $y1, $x3, $y3);
        // Show label only in dev mode
        if ($isDevMode) {
            $svg .= sprintf('<text class="snip-label" x="%.2f" y="%.2f" text-anchor="middle" dominant-baseline="middle" font-size="8px" fill="black">%s</text>', $labelX, $labelY, htmlspecialchars($nodeName));
        }
        $svg .= '</g>';
        return $svg;
    }
}

// Scissors Icon helper
if (!function_exists('scissorsIcon')) {
    function scissorsIcon($x, $y, $rotation = 0, $size = 0.5, $color = '#333333', $label = '') {
        global $scale, $isDevMode;
        $sizeScaled = $size * $scale;
        $scissorsPath = 'M9.64 7.64c.23-.5.36-1.05.36-1.64 0-2.21-1.79-4-4-4S2 3.79 2 6s1.79 4 4 4c.59 0 1.14-.13 1.64-.36L10 12l-2.36 2.36C7.14 14.13 6.59 14 6 14c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4c0-.59-.13-1.14-.36-1.64L12 14l7 7h3v-1L9.64 7.64zM6 8c-1.1 0-2-.89-2-2s.9-2 2-2 2 .89 2 2-.9 2-2 2zm0 12c-1.1 0-2-.89-2-2s.9-2 2-2 2 .89 2 2-.9 2-2 2zm6-7.5c-.28 0-.5-.22-.5-.5s.22-.5.5-.5.5.22.5.5-.22.5-.5.5zM19 3l-6 6 2 2 7-7V3h-3z';
        $pathScale = $sizeScaled / 24;
        $svg = sprintf('<g transform="translate(%.2f, %.2f) rotate(%d) scale(%.4f) translate(-12, -12)">', $x, $y, $rotation, $pathScale);
        $svg .= sprintf('<path d="%s" fill="%s"/>', $scissorsPath, $color);
        $svg .= '</g>';
        // Add label if provided (8px font-size, black color) - only in dev mode
        if (!empty($label) && $isDevMode) {
            $labelOffsetY = $sizeScaled + 3; // Position label below scissors icon
            $svg .= sprintf('<text x="%.2f" y="%.2f" font-size="8px" fill="#000000" text-anchor="middle" font-family="Arial, sans-serif">%s</text>', $x, $y + $labelOffsetY, htmlspecialchars($label));
        }
        return $svg;
    }
}

// Grainline helper
if (!function_exists('grainLine')) {
    function grainLine($x, $y, $length, $orientation = 'vertical') {
        global $scale;
        $lengthScaled = $length * $scale;
        $arrowSize = 0.15 * $scale;

        if ($orientation === 'vertical') {
            $x1 = $x; $y1 = $y - ($lengthScaled / 2);
            $x2 = $x; $y2 = $y + ($lengthScaled / 2);
            $svg = '<g class="grainline">';
            $svg .= sprintf('<line x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#000" stroke-width="0.5"/>', $x1, $y1, $x2, $y2);
            $svg .= sprintf('<line x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#000" stroke-width="0.5"/>', $x1, $y1, $x1 - $arrowSize, $y1 + $arrowSize);
            $svg .= sprintf('<line x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#000" stroke-width="0.5"/>', $x1, $y1, $x1 + $arrowSize, $y1 + $arrowSize);
            $svg .= sprintf('<line x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#000" stroke-width="0.5"/>', $x2, $y2, $x2 - $arrowSize, $y2 - $arrowSize);
            $svg .= sprintf('<line x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#000" stroke-width="0.5"/>', $x2, $y2, $x2 + $arrowSize, $y2 - $arrowSize);
            $svg .= sprintf('<text x="%.2f" y="%.2f" font-size="%.2f" font-family="Arial, sans-serif" fill="#000" text-anchor="middle" transform="rotate(-90 %.2f %.2f)">GRAINLINE</text>', $x + (0.25 * $scale), $y, 0.15 * $scale, $x + (0.25 * $scale), $y);
            $svg .= '</g>';
        } else {
            $x1 = $x - ($lengthScaled / 2); $y1 = $y;
            $x2 = $x + ($lengthScaled / 2); $y2 = $y;
            $svg = '<g class="grainline">';
            $svg .= sprintf('<line x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#000" stroke-width="0.5"/>', $x1, $y1, $x2, $y2);
            $svg .= sprintf('<line x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#000" stroke-width="0.5"/>', $x1, $y1, $x1 + $arrowSize, $y1 - $arrowSize);
            $svg .= sprintf('<line x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#000" stroke-width="0.5"/>', $x1, $y1, $x1 + $arrowSize, $y1 + $arrowSize);
            $svg .= sprintf('<line x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#000" stroke-width="0.5"/>', $x2, $y2, $x2 - $arrowSize, $y2 - $arrowSize);
            $svg .= sprintf('<line x1="%.2f" y1="%.2f" x2="%.2f" y2="%.2f" stroke="#000" stroke-width="0.5"/>', $x2, $y2, $x2 - $arrowSize, $y2 + $arrowSize);
            $svg .= sprintf('<text x="%.2f" y="%.2f" font-size="%.2f" font-family="Arial, sans-serif" fill="#000" text-anchor="middle">GRAINLINE</text>', $x, $y - (0.25 * $scale), 0.15 * $scale);
            $svg .= '</g>';
        }
        return $svg;
    }
}

// =============================================================================
// SECTION 3: SVG GENERATION
// =============================================================================

// Calculate cutting line control points
$seamOffsetPx = 0.5 * $scale;
// Use 0.25" offset for waist curve to match r1-r2 offset
$cut_waist_ctrl_x = $q_ctrl_left_x;
$cut_waist_ctrl_y = $q_ctrl_left_y + (0.25 * $scale);
$cut_neck_ctrl1_x = frontNode('a111','x') - $seamOffsetPx;
$cut_neck_ctrl1_y = frontNode('a1','y');
$cut_neck_ctrl2_x = frontNode('a111','x') - $seamOffsetPx;
$cut_neck_ctrl2_y = frontNode('a11','y');

// Calculate tuck center points
$b_center_x = (frontNode('b2','x') + frontNode('b4','x')) / 2;
$b_center_y = frontNode('b2','y');
$c_center_x = frontNode('c1','x');
$c_center_y = (frontNode('c1','y') + frontNode('c3','y')) / 2;

// Generate SVG content
ob_start();
?>
<svg id="frontPatternSvg" width="<?php echo $frontSvgWidth; ?>" height="<?php echo $frontSvgHeight; ?>"
     viewBox="<?php echo $frontBounds['minX']; ?> <?php echo $frontBounds['minY']; ?> <?php echo $frontBounds['width']; ?> <?php echo $frontBounds['height']; ?>"
     xmlns="http://www.w3.org/2000/svg">
    <rect width="100%" height="100%" fill="#fff"/>

    <?php if ($isDevMode): ?>
    <!-- Margin guides -->
    <line x1="<?php echo $originX; ?>" y1="0" x2="<?php echo $originX; ?>" y2="<?php echo $frontSvgHeight; ?>" stroke="#eee" stroke-dasharray="4,4"/>
    <line x1="0" y1="<?php echo $originY; ?>" x2="<?php echo $frontSvgWidth; ?>" y2="<?php echo $originY; ?>" stroke="#eee" stroke-dasharray="4,4"/>
    <?php endif; ?>

    <!-- Armhole curve -->
    <path d="<?php echo $armholeSvgPath; ?>" stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>

    <!-- Shoulder line: a11 to a10 -->
    <line x1="<?php echo frontNode('a11','x'); ?>" y1="<?php echo frontNode('a11','y'); ?>"
          x2="<?php echo frontNode('a10','x'); ?>" y2="<?php echo frontNode('a10','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>

    <!-- Front neck: curve a1 to a111, then straight line a111 to a11 -->
    <path d="M <?php echo frontNode('a1','x'); ?>,<?php echo frontNode('a1','y'); ?> Q <?php echo frontNode('a111','x'); ?>,<?php echo frontNode('a1','y'); ?> <?php echo frontNode('a111','x'); ?>,<?php echo frontNode('a111','y'); ?> L <?php echo frontNode('a11','x'); ?>,<?php echo frontNode('a11','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>

    <!-- Center front line: a1 to a3 -->
    <line x1="<?php echo frontNode('a1','x'); ?>" y1="<?php echo frontNode('a1','y'); ?>"
          x2="<?php echo frontNode('a3','x'); ?>" y2="<?php echo frontNode('a3','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>

    <!-- Waist line: curve a3 → a4, line a4 → a5 -->
    <path d="M <?php echo frontNode('a4','x'); ?>,<?php echo frontNode('a4','y'); ?>
             Q <?php echo $q_ctrl_left_x; ?>,<?php echo $q_ctrl_left_y; ?>
               <?php echo frontNode('a3','x'); ?>,<?php echo frontNode('a3','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
    <line x1="<?php echo frontNode('a4','x'); ?>" y1="<?php echo frontNode('a4','y'); ?>"
          x2="<?php echo frontNode('a5','x'); ?>" y2="<?php echo frontNode('a5','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>

    <!-- BOTTOM TUCK: b2 → b3 → b4 -->
    <line x1="<?php echo frontNode('b2','x'); ?>" y1="<?php echo frontNode('b2','y'); ?>"
          x2="<?php echo frontNode('b3','x'); ?>" y2="<?php echo frontNode('b3','y'); ?>"
          stroke="#808080" stroke-width="0.5"/>
    <line x1="<?php echo frontNode('b3','x'); ?>" y1="<?php echo frontNode('b3','y'); ?>"
          x2="<?php echo frontNode('b4','x'); ?>" y2="<?php echo frontNode('b4','y'); ?>"
          stroke="#808080" stroke-width="0.5"/>
    <line x1="<?php echo frontNode('b3','x'); ?>" y1="<?php echo frontNode('b3','y'); ?>"
          x2="<?php echo $b_center_x; ?>" y2="<?php echo $b_center_y; ?>"
          stroke="#000" stroke-width="0.5" stroke-dasharray="2,2"/>

    <!-- SIDE TUCK LEFT: c1 → c2 → c3 -->
    <line x1="<?php echo frontNode('c1','x'); ?>" y1="<?php echo frontNode('c1','y'); ?>"
          x2="<?php echo frontNode('c2','x'); ?>" y2="<?php echo frontNode('c2','y'); ?>"
          stroke="#808080" stroke-width="0.5"/>
    <line x1="<?php echo frontNode('c2','x'); ?>" y1="<?php echo frontNode('c2','y'); ?>"
          x2="<?php echo frontNode('c3','x'); ?>" y2="<?php echo frontNode('c3','y'); ?>"
          stroke="#808080" stroke-width="0.5"/>
    <line x1="<?php echo frontNode('c2','x'); ?>" y1="<?php echo frontNode('c2','y'); ?>"
          x2="<?php echo $c_center_x; ?>" y2="<?php echo $c_center_y; ?>"
          stroke="#000" stroke-width="0.5" stroke-dasharray="2,2"/>

    <!-- ARMHOLE TUCK: e1 → e2 → e3 -->
    <line x1="<?php echo frontNode('e1','x'); ?>" y1="<?php echo frontNode('e1','y'); ?>"
          x2="<?php echo frontNode('e2','x'); ?>" y2="<?php echo frontNode('e2','y'); ?>"
          stroke="#808080" stroke-width="0.5"/>
    <line x1="<?php echo frontNode('e2','x'); ?>" y1="<?php echo frontNode('e2','y'); ?>"
          x2="<?php echo frontNode('e3','x'); ?>" y2="<?php echo frontNode('e3','y'); ?>"
          stroke="#808080" stroke-width="0.5"/>
    <line x1="<?php echo frontNode('e2','x'); ?>" y1="<?php echo frontNode('e2','y'); ?>"
          x2="<?php echo frontNode('a9','x'); ?>" y2="<?php echo frontNode('a9','y'); ?>"
          stroke="#000" stroke-width="0.5" stroke-dasharray="2,2"/>

    <!-- 4TH TUCK: f1 → f2 → f3 (base on a7-a5 line, apex at b1.x + 1") -->
    <line x1="<?php echo frontNode('f1','x'); ?>" y1="<?php echo frontNode('f1','y'); ?>"
          x2="<?php echo frontNode('f2','x'); ?>" y2="<?php echo frontNode('f2','y'); ?>"
          stroke="#808080" stroke-width="0.5"/>
    <line x1="<?php echo frontNode('f2','x'); ?>" y1="<?php echo frontNode('f2','y'); ?>"
          x2="<?php echo frontNode('f3','x'); ?>" y2="<?php echo frontNode('f3','y'); ?>"
          stroke="#808080" stroke-width="0.5"/>
    <?php
    // Calculate center point between f1 and f3 for the fold line
    $f_center_x = frontNode('f1', 'x');
    $f_center_y = (frontNode('f1', 'y') + frontNode('f3', 'y')) / 2;
    ?>
    <line x1="<?php echo frontNode('f2','x'); ?>" y1="<?php echo frontNode('f2','y'); ?>"
          x2="<?php echo $f_center_x; ?>" y2="<?php echo $f_center_y; ?>"
          stroke="#000" stroke-width="0.5" stroke-dasharray="2,2"/>

    <!-- Side seam: a5 to a7 to a8 -->
    <line x1="<?php echo frontNode('a5','x'); ?>" y1="<?php echo frontNode('a5','y'); ?>"
          x2="<?php echo frontNode('a7','x'); ?>" y2="<?php echo frontNode('a7','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <line x1="<?php echo frontNode('a7','x'); ?>" y1="<?php echo frontNode('a7','y'); ?>"
          x2="<?php echo frontNode('a8','x'); ?>" y2="<?php echo frontNode('a8','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>

    <!-- Side box: a7 -> a71 -> a51 -> a5 (1" wide rectangle) -->
    <line x1="<?php echo frontNode('a7','x'); ?>" y1="<?php echo frontNode('a7','y'); ?>"
          x2="<?php echo frontNode('a71','x'); ?>" y2="<?php echo frontNode('a71','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <line x1="<?php echo frontNode('a71','x'); ?>" y1="<?php echo frontNode('a71','y'); ?>"
          x2="<?php echo frontNode('a51','x'); ?>" y2="<?php echo frontNode('a51','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
    <line x1="<?php echo frontNode('a51','x'); ?>" y1="<?php echo frontNode('a51','y'); ?>"
          x2="<?php echo frontNode('a5','x'); ?>" y2="<?php echo frontNode('a5','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>

    <!-- Ease text (in side box - centered between a7-a5 and a71-a51) -->
    <?php
    // Horizontal center: midpoint between left edge (a7/a5) and right edge (a71/a51)
    $easeTextX = (frontNode('a7', 'x') + frontNode('a71', 'x')) / 2;
    // Vertical center: midpoint between top (a7/a71) and bottom (a5/a51)
    $easeTextY = (frontNode('a7', 'y') + frontNode('a5', 'y')) / 2;
    ?>
    <text x="<?php echo $easeTextX; ?>" y="<?php echo $easeTextY; ?>"
          font-size="10" fill="#666" text-anchor="middle"
          transform="rotate(90, <?php echo $easeTextX; ?>, <?php echo $easeTextY; ?>)">---- ease -----</text>

    <!-- CUTTING LINE (RED) - matches sariBlouse.php stroke style -->
    <path d="M <?php echo frontNode('r1','x'); ?>,<?php echo frontNode('r1','y'); ?>
             Q <?php echo $cut_waist_ctrl_x; ?>,<?php echo $cut_waist_ctrl_y; ?>
               <?php echo frontNode('r2','x'); ?>,<?php echo frontNode('r2','y'); ?>
             L <?php echo frontNode('r3','x'); ?>,<?php echo frontNode('r3','y'); ?>
             L <?php echo frontNode('r5','x'); ?>,<?php echo frontNode('r5','y'); ?>
             L <?php echo frontNode('r6','x'); ?>,<?php echo frontNode('r6','y'); ?>
             Q <?php echo frontNode('r71','x'); ?>,<?php echo frontNode('r6','y'); ?>
               <?php echo frontNode('r71','x'); ?>,<?php echo frontNode('r71','y'); ?>
             Q <?php echo frontNode('r71','x') - (0.45 * $scale); ?>,<?php echo (frontNode('r71','y') + frontNode('r7','y')) / 2; ?>
               <?php echo frontNode('r7','x'); ?>,<?php echo frontNode('r7','y'); ?>
             L <?php echo frontNode('r8','x'); ?>,<?php echo frontNode('r8','y'); ?>
             L <?php echo frontNode('r91','x'); ?>,<?php echo frontNode('r91','y'); ?>
             Q <?php echo frontNode('r91','x'); ?>,<?php echo frontNode('r9','y'); ?>
               <?php echo frontNode('r9','x'); ?>,<?php echo frontNode('r9','y'); ?>
             L <?php echo frontNode('r1','x'); ?>,<?php echo frontNode('r1','y'); ?>"
          stroke="#DC2626" stroke-width="0.5" stroke-dasharray="6,3" fill="none"/>

    <!-- Scissors Icon on front cutting line at r5 -->
    <?php echo scissorsIcon(frontNode('r5','x'), frontNode('r5','y'), 90, 0.4, '#333333', 'r5'); ?>

    <!-- Grainline -->
    <?php
    // Position grainline between b1 and sMid points
    $grainX = (frontNode('b1', 'x') + frontNode('sMid', 'x')) / 2; // Midpoint between b1 and sMid horizontally
    $grainY = (frontNode('b1', 'y') + frontNode('sMid', 'y')) / 2; // Midpoint between b1 and sMid vertically
    $grainLength = 4; // 4 inches long
    echo grainLine($grainX, $grainY, $grainLength, 'vertical');
    ?>

    <?php if ($isPrintMode): ?>
    <!-- X markers at node positions (Print Mode Only) -->
    <!-- a8 node X marker -->
    <text x="<?php echo frontNode('a8', 'x'); ?>" y="<?php echo frontNode('a8', 'y'); ?>"
          font-size="6" text-anchor="middle" dominant-baseline="middle" fill="#000">X</text>

    <!-- a7 node X marker -->
    <text x="<?php echo frontNode('a7', 'x'); ?>" y="<?php echo frontNode('a7', 'y'); ?>"
          font-size="6" text-anchor="middle" dominant-baseline="middle" fill="#000">X</text>
    <?php endif; ?>

    <?php if ($isDevMode): ?>
    <!-- Node Labels (Dev Mode Only) -->
    <?php foreach ($frontNodes as $name => $node): ?>
        <?php if (!isset($node['color']) || $node['color'] !== 'red'): ?>
        <?php
            $nodeColor = '#10B981';  // Default green
            if (isset($node['color'])) {
                if ($node['color'] === 'gray') $nodeColor = '#9CA3AF';
            }
        ?>
        <circle cx="<?php echo $node['x']; ?>" cy="<?php echo $node['y']; ?>" r="2"
                fill="<?php echo $nodeColor; ?>" stroke="#fff" stroke-width="1"/>
        <text x="<?php echo $node['x'] + 3; ?>" y="<?php echo $node['y'] - 3; ?>"
              font-size="8" fill="<?php echo $nodeColor; ?>" font-weight="300" opacity="0.7"><?php echo $name; ?></text>
        <?php endif; ?>
    <?php endforeach; ?>

    <!-- Cutting line nodes (red) -->
    <?php foreach ($frontNodes as $name => $node): ?>
        <?php if (isset($node['color']) && $node['color'] === 'red'): ?>
        <circle cx="<?php echo $node['x']; ?>" cy="<?php echo $node['y']; ?>" r="2"
                fill="#DC2626" stroke="#fff" stroke-width="1"/>
        <text x="<?php echo $node['x'] + 3; ?>" y="<?php echo $node['y'] - 3; ?>"
              font-size="8" fill="#DC2626" font-weight="300" opacity="0.7"><?php echo $name; ?></text>
        <?php endif; ?>
    <?php endforeach; ?>
    <?php endif; ?>

    <!-- ========== PATTI PATTERN (below front) ========== -->
    <!-- Patti black pattern outline -->
    <!-- Top curve: p1 -> p2 with control point -->
    <path d="M <?php echo pattiNode('p2','x'); ?>,<?php echo pattiNode('p2','y'); ?>
             Q <?php echo $p_ctrl_x; ?>,<?php echo $p_ctrl_y; ?>
               <?php echo pattiNode('p1','x'); ?>,<?php echo pattiNode('p1','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" fill="none"/>

    <!-- p2 to p3 (straight line) -->
    <line x1="<?php echo pattiNode('p2','x'); ?>" y1="<?php echo pattiNode('p2','y'); ?>"
          x2="<?php echo pattiNode('p3','x'); ?>" y2="<?php echo pattiNode('p3','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>

    <!-- p3 to p5 (right side) -->
    <line x1="<?php echo pattiNode('p3','x'); ?>" y1="<?php echo pattiNode('p3','y'); ?>"
          x2="<?php echo pattiNode('p5','x'); ?>" y2="<?php echo pattiNode('p5','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>

    <!-- p5 to p4 (bottom) -->
    <line x1="<?php echo pattiNode('p5','x'); ?>" y1="<?php echo pattiNode('p5','y'); ?>"
          x2="<?php echo pattiNode('p4','x'); ?>" y2="<?php echo pattiNode('p4','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>

    <!-- p4 to p1 (left side) -->
    <line x1="<?php echo pattiNode('p4','x'); ?>" y1="<?php echo pattiNode('p4','y'); ?>"
          x2="<?php echo pattiNode('p1','x'); ?>" y2="<?php echo pattiNode('p1','y'); ?>"
          stroke="#000" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>

    <!-- Patti Grainline (centered between p4 and p5) -->
    <?php
    $pattiGrainX = (pattiNode('p4', 'x') + pattiNode('p5', 'x')) / 2;
    $pattiGrainY = (pattiNode('p2', 'y') + pattiNode('p4', 'y')) / 2;
    $pattiGrainLength = 3;
    echo grainLine($pattiGrainX, $pattiGrainY, $pattiGrainLength, 'horizontal');
    ?>

    <?php if ($isDevMode): ?>
    <!-- Patti Node Labels (Dev Mode Only) -->
    <?php foreach ($pattiNodes as $name => $node): ?>
        <circle cx="<?php echo $node['x']; ?>" cy="<?php echo $node['y']; ?>" r="2"
                fill="#10B981" stroke="#fff" stroke-width="1"/>
        <text x="<?php echo $node['x'] + 3; ?>" y="<?php echo $node['y'] - 3; ?>"
              font-size="8" fill="#10B981" font-weight="300" opacity="0.7"><?php echo $name; ?></text>
    <?php endforeach; ?>
    <?php endif; ?>
</svg>
<?php
$frontSvgContent = ob_get_clean();

// =============================================================================
// SECTION 4: EXPORT DATA (For composites & PDF)
// =============================================================================
$frontPatternData = [
    'name' => 'FRONT + PATTI',
    'type' => 'sariBlouseFront',
    'nodes' => $frontNodes,
    'pattiNodes' => $pattiNodes,
    'svg_content' => $frontSvgContent,
    'dimensions' => [
        'width' => $frontSvgWidth,
        'height' => $frontSvgHeight,
        'widthInches' => $frontSvgWidthInches,
        'heightInches' => $frontSvgHeightInches
    ],
    'bounds' => $frontBounds,
    'patti' => [
        'width' => $pattiWidth,
        'height' => $pattiHeight,
        'originX' => $pattiOriginX,
        'originY' => $pattiOriginY
    ]
];

// =============================================================================
// SECTION 5: STANDALONE PREVIEW (Only if not in composite mode)
// =============================================================================
if (defined('COMPOSITE_MODE')) {
    // Composite is including us - just return, data is set
    return;
}

// Standalone preview mode - render full HTML
?>
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Blouse Front - <?php echo htmlspecialchars($customerName); ?></title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .pattern-container { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 10px; }
        .info { color: #666; margin-bottom: 20px; font-size: 14px; }
        .svg-container { border: 1px solid #ddd; background: white; overflow: auto; }

        /* Mode Switcher */
        .mode-switcher { display: flex; gap: 8px; margin-bottom: 15px; }
        .mode-btn { padding: 8px 16px; border: 1px solid #ddd; background: #f5f5f5; cursor: pointer; border-radius: 4px; font-size: 14px; text-decoration: none; color: #333; }
        .mode-btn:hover { background: #e0e0e0; }
        .mode-btn.active { background: #333; color: white; border-color: #333; }
    </style>
</head>
<body>
    <div class="pattern-container">
        <h1>Blouse Front Pattern</h1>

        <!-- Mode Switcher -->
        <div class="mode-switcher">
            <?php
            $baseUrl = strtok($_SERVER['REQUEST_URI'], '?');
            $params = $_GET;
            ?>
            <a href="<?php $params['mode'] = 'dev'; echo $baseUrl . '?' . http_build_query($params); ?>"
               class="mode-btn <?php echo $isDevMode ? 'active' : ''; ?>">Dev</a>
            <a href="<?php $params['mode'] = 'print'; echo $baseUrl . '?' . http_build_query($params); ?>"
               class="mode-btn <?php echo $isPrintMode ? 'active' : ''; ?>">Print</a>
        </div>

        <?php if ($isDevMode): ?>
        <div class="info">
            Customer: <?php echo htmlspecialchars($customerName); ?> |
            Bust: <?php echo $bust; ?>" |
            Armhole: <?php echo $armhole; ?>" |
            Patti: <?php echo number_format($pattiWidth, 2); ?>" x <?php echo number_format($pattiHeight, 2); ?>"
        </div>
        <?php endif; ?>

        <div class="svg-container">
            <?php echo $frontSvgContent; ?>
        </div>
    </div>
</body>
</html>
